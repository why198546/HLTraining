# Nano Banana 图像生成功能实现文档

## 概述

本项目成功实现了 **Nano Banana** (Google Gemini 2.5 Flash Image) 图像生成功能，为10-14岁儿童提供AI驱动的创意体验。

## 功能特性

### 1. 文字生成图片 (Text-to-Image)
使用 Gemini 2.5 Flash Image 模型根据文字描述生成图片。

**特点:**
- 🎨 AI智能理解文字描述
- 👶 专为儿童优化的提示词工程
- 🎭 支持多种风格选择（可爱、写实、动漫、奇幻）
- 🌈 灵活的色彩偏好设置
- 🛡️ 自动降级到备用方案（无API密钥时）

### 2. 手绘简笔画上色 (Sketch Colorization)
上传手绘简笔画，AI根据用户描述进行智能上色。

**特点:**
- ✏️ 支持多种图片格式
- 🎨 根据用户描述定制上色
- 🖼️ 自动图像预处理
- 🏺 生成手办风格效果

### 3. 手办风格转换 (Figurine Style)
将彩色图片转换为手办风格。

**特点:**
- 🏺 逼真的塑料质感
- ✨ 增强的光泽效果
- 🎯 保持原始构图
- 👶 适合儿童的可爱风格

## 技术架构

### 核心组件

#### 1. NanoBananaAPI 类 (`api/nano_banana.py`)

```python
class NanoBananaAPI:
    """Nano Banana API类 - 使用Gemini 2.5 Flash Image实现"""
    
    def __init__(self):
        # 初始化 Gemini 客户端
        # 从环境变量获取 API 密钥
        
    def generate_image_from_text(self, text_prompt):
        """从文字描述生成图片"""
        
    def colorize_sketch(self, sketch_path, description=""):
        """为手绘简笔画上色"""
        
    def generate_figurine_style(self, colored_image_path, description=""):
        """生成手办风格图片"""
        
    def check_api_status(self):
        """检查 API 状态"""
```

#### 2. Flask 路由 (`app.py`)

| 路由 | 方法 | 功能 |
|------|------|------|
| `/` | GET | 主页 |
| `/generate-from-text` | POST | 文字生成图片 |
| `/upload` | POST | 上传图片 |
| `/colorize` | POST | 图片上色 |
| `/generate_3d` | POST | 生成3D模型 |
| `/uploads/<filename>` | GET | 访问上传的文件 |

#### 3. 前端交互 (`static/js/main.js`)

- 两种创作模式选择
- 文件上传和预览
- 处理进度显示
- 结果展示和下载
- 错误处理和用户反馈

## 安装和配置

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

**关键依赖:**
- `Flask>=3.0.0` - Web框架
- `google-generativeai>=0.8.0` - Gemini API
- `python-dotenv>=1.0.0` - 环境变量管理
- `Pillow>=10.0.0` - 图像处理
- `opencv-python>=4.8.0` - 计算机视觉
- `requests>=2.31.0` - HTTP请求
- `numpy>=1.24.0` - 数值计算

### 2. 配置 API 密钥

#### 方法 1: 环境变量

```bash
export GEMINI_API_KEY='your-gemini-api-key-here'
```

#### 方法 2: .env 文件

创建 `.env` 文件:
```env
GEMINI_API_KEY=your-gemini-api-key-here
```

#### 获取 API 密钥

访问: https://aistudio.google.com/app/apikey

1. 登录 Google 账户
2. 创建新的 API 密钥
3. 复制密钥并配置到环境变量

### 3. 运行应用

```bash
python app.py
```

应用将在 `http://localhost:5001` 启动。

## 使用指南

### 文字创作模式

1. 在主页选择"文字创作模式"
2. 输入创意描述（例如："一只可爱的小猫，戴着红色帽子"）
3. 选择图片风格和色彩偏好
4. 点击"开始生成"
5. 等待 AI 生成图片
6. 查看结果并可选择生成 3D 模型

### 手绘创作模式

1. 在主页选择"手绘创作模式"
2. 上传手绘简笔画
3. 输入上色要求（例如："把这个笑脸涂成黄色"）
4. 点击"开始上色"
5. 等待 AI 处理
6. 查看上色结果和手办风格效果

## API 工作流程

### 文字生成图片流程

```
用户输入文字描述
    ↓
构建儿童友好的提示词
    ↓
调用 Gemini 2.5 Flash Image
    ↓
生成图片数据
    ↓
保存到 uploads/ 目录
    ↓
返回图片路径
    ↓
(可选) 生成 3D 模型
```

### 手绘上色流程

```
用户上传图片
    ↓
图像预处理（灰度化、二值化）
    ↓
根据用户描述构建提示词
    ↓
调用 Gemini API 进行上色
    ↓
生成上色图片
    ↓
(可选) 生成手办风格
    ↓
返回结果
```

## 错误处理

### 1. API 配额耗尽

**症状:** 返回 429 或 RESOURCE_EXHAUSTED 错误

**解决方案:**
- 等待配额重置（通常每天UTC时间重置）
- 升级到付费版本
- 使用备用方案（系统会自动降级）

### 2. API 密钥无效

**症状:** API 初始化失败或返回认证错误

**解决方案:**
- 检查 GEMINI_API_KEY 环境变量
- 确认 API 密钥有效
- 重新生成 API 密钥

### 3. 网络连接问题

**症状:** 请求超时或连接失败

**解决方案:**
- 检查网络连接
- 使用代理（如需要）
- 增加超时时间

## 测试

### 运行功能测试

```bash
# 完整功能测试
python test_nano_banana_functionality.py

# API 端点测试
python test_api_endpoints.py
```

### 测试覆盖

- ✅ 依赖导入验证
- ✅ API 类结构检查
- ✅ API 初始化测试
- ✅ Flask 路由验证
- ✅ 目录结构检查
- ✅ 端点响应测试

## 性能优化

### 1. 图片处理
- 自动调整图片大小
- 优化文件格式
- 压缩存储空间

### 2. API 调用
- 智能重试机制
- 错误降级处理
- 响应缓存（未来功能）

### 3. 用户体验
- 异步处理
- 进度显示
- 实时反馈

## 安全考虑

### 1. API 密钥保护
- 使用环境变量存储
- 不提交到版本控制
- 定期轮换密钥

### 2. 文件上传安全
- 文件类型验证
- 文件大小限制（16MB）
- 安全的文件名处理
- 上传目录隔离

### 3. 内容过滤
- 儿童友好内容确保
- 提示词安全检查
- 结果内容审查

## 维护和监控

### 日志记录

应用会记录以下信息:
- API 调用状态
- 错误信息
- 用户操作
- 系统性能

### 监控指标

关键监控点:
- API 调用成功率
- 响应时间
- 错误频率
- 用户活跃度

## 未来改进

### 计划功能
- [ ] 批量图片生成
- [ ] 更多风格选项
- [ ] 图片编辑功能
- [ ] 社区分享功能
- [ ] 作品收藏系统

### 技术升级
- [ ] 响应缓存
- [ ] WebSocket 实时通信
- [ ] 更快的 3D 生成
- [ ] 移动端优化

## 常见问题 (FAQ)

### Q: 为什么生成图片失败？
A: 可能原因:
1. 没有配置 API 密钥
2. API 配额已用完
3. 网络连接问题
4. 提示词不合适

### Q: 如何获得更好的生成效果？
A: 建议:
1. 提供详细的描述
2. 指定具体的颜色、形状
3. 使用清晰的表达
4. 多次尝试不同描述

### Q: 支持哪些图片格式？
A: 支持的格式:
- PNG
- JPG/JPEG
- GIF
- BMP

### Q: 文件大小限制是多少？
A: 最大 16MB

### Q: 生成的图片保存在哪里？
A: 保存在 `uploads/` 目录下

## 贡献指南

欢迎贡献！请遵循以下步骤:

1. Fork 项目
2. 创建功能分支
3. 提交更改
4. 推送到分支
5. 创建 Pull Request

## 许可证

本项目专为教育目的设计，适用于10-14岁儿童的AI学习体验。

## 联系方式

如有问题或建议，请通过以下方式联系:
- 创建 GitHub Issue
- 查看项目文档
- 参考在线教程

---

**最后更新:** 2025-10-18

**版本:** 1.0.0

**状态:** ✅ 生产就绪
