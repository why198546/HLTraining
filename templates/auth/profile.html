<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„èµ„æ–™ - AIåˆ›æ„å·¥åŠ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    {% include 'components/header.html' %}
    </header>

    <main class="main-content profile-page">
        <div class="container">
            <div class="profile-container">
                <!-- ç”¨æˆ·å¤´åƒå’ŒåŸºæœ¬ä¿¡æ¯ -->
                <div class="profile-header">
                    <div class="user-avatar-section">
                        <div class="user-avatar large">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <div class="user-basic-info">
                            <h1>{{ user.nickname }}</h1>
                            <p class="user-meta">@{{ user.username }} Â· {{ user.age }}å²</p>
                            <p class="join-date">{{ user.created_at.strftime('%Yå¹´%mæœˆ%dæ—¥') }} åŠ å…¥</p>
                        </div>
                    </div>
                    
                    <div class="user-stats">
                        <div class="stat-item">
                            <div class="stat-number">{{ artwork_count }}</div>
                            <div class="stat-label">åˆ›ä½œä½œå“</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">{{ session_count }}</div>
                            <div class="stat-label">åˆ›ä½œæ¬¡æ•°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">{{ days_joined }}</div>
                            <div class="stat-label">åŠ å…¥å¤©æ•°</div>
                        </div>
                    </div>
                </div>

                <!-- æˆå°±å¾½ç«  -->
                <div class="achievements-section">
                    <h2>ğŸ† æˆ‘çš„æˆå°±</h2>
                    <div class="achievements-grid">
                        <div class="achievement-badge {{ 'earned' if artwork_count >= 1 else 'locked' }}">
                            <div class="badge-icon">
                                <i class="fas fa-star"></i>
                            </div>
                            <h4>åˆæ¬¡åˆ›ä½œ</h4>
                            <p>å®Œæˆç¬¬ä¸€ä»¶ä½œå“</p>
                        </div>
                        
                        <div class="achievement-badge {{ 'earned' if artwork_count >= 5 else 'locked' }}">
                            <div class="badge-icon">
                                <i class="fas fa-palette"></i>
                            </div>
                            <h4>å°ç”»å®¶</h4>
                            <p>åˆ›ä½œ5ä»¶ä½œå“</p>
                        </div>
                        
                        <div class="achievement-badge {{ 'earned' if artwork_count >= 10 else 'locked' }}">
                            <div class="badge-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <h4>åˆ›ä½œå¤§å¸ˆ</h4>
                            <p>åˆ›ä½œ10ä»¶ä½œå“</p>
                        </div>
                        
                        <div class="achievement-badge {{ 'earned' if days_joined >= 7 else 'locked' }}">
                            <div class="badge-icon">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <h4>ä¸€å‘¨è¾¾äºº</h4>
                            <p>è¿ç»­ä½¿ç”¨7å¤©</p>
                        </div>
                    </div>
                </div>

                <!-- ä¸ªäººèµ„æ–™ç¼–è¾‘ -->
                <div class="profile-edit-section">
                    <h2>âœï¸ ç¼–è¾‘èµ„æ–™</h2>
                    
                    <form method="POST" class="profile-form">
                        {{ form.hidden_tag() }}
                        <input type="hidden" name="form_type" value="profile">
                        
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="{{ form.nickname.id }}">
                                    <i class="fas fa-user"></i>
                                    æ˜µç§°
                                </label>
                                {{ form.nickname(class="form-input") }}
                                {% if form.nickname.errors %}
                                    <div class="error-messages">
                                        {% for error in form.nickname.errors %}
                                            <p class="error-message">{{ error }}</p>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="form-group">
                                <label for="{{ form.role.id }}">
                                    <i class="fas fa-user-tag"></i>
                                    è§’è‰²
                                </label>
                                {{ form.role(class="form-select", id="role-select") }}
                                {% if form.role.errors %}
                                    <div class="error-messages">
                                        {% for error in form.role.errors %}
                                            <p class="error-message">{{ error }}</p>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="form-group">
                                <label for="{{ form.birth_date.id }}">
                                    <i class="fas fa-birthday-cake"></i>
                                    å‡ºç”Ÿæ—¥æœŸ <span id="age-hint" class="age-hint"></span>
                                </label>
                                {{ form.birth_date(class="form-input", id="birth-date-input") }}
                                {% if form.birth_date.errors %}
                                    <div class="error-messages">
                                        {% for error in form.birth_date.errors %}
                                            <p class="error-message">{{ error }}</p>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="form-group">
                                <label for="{{ form.gender.id }}">
                                    <i class="fas fa-venus-mars"></i>
                                    æ€§åˆ«
                                </label>
                                {{ form.gender(class="form-select") }}
                                {% if form.gender.errors %}
                                    <div class="error-messages">
                                        {% for error in form.gender.errors %}
                                            <p class="error-message">{{ error }}</p>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="form-group">
                                <label for="{{ form.contact_phone.id }}">
                                    <i class="fas fa-phone"></i>
                                    è”ç³»ç”µè¯
                                </label>
                                {{ form.contact_phone(class="form-input", placeholder="è”ç³»ç”µè¯ï¼ˆå¯é€‰ï¼‰") }}
                                {% if form.contact_phone.errors %}
                                    <div class="error-messages">
                                        {% for error in form.contact_phone.errors %}
                                            <p class="error-message">{{ error }}</p>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="form-group">
                                <label for="{{ form.mailing_address.id }}">
                                    <i class="fas fa-map-marker-alt"></i>
                                    é‚®å¯„åœ°å€
                                </label>
                                {{ form.mailing_address(class="form-textarea", placeholder="é‚®å¯„åœ°å€ï¼ˆå¯é€‰ï¼Œç”¨äº3Dæ¨¡å‹é‚®å¯„ï¼‰", rows="3") }}
                                {% if form.mailing_address.errors %}
                                    <div class="error-messages">
                                        {% for error in form.mailing_address.errors %}
                                            <p class="error-message">{{ error }}</p>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="form-group">
                                <label for="{{ form.color_preference.id }}">
                                    <i class="fas fa-palette"></i>
                                    å–œæ¬¢çš„è‰²å½©é£æ ¼
                                </label>
                                {{ form.color_preference(class="form-select") }}
                                {% if form.color_preference.errors %}
                                    <div class="error-messages">
                                        {% for error in form.color_preference.errors %}
                                            <p class="error-message">{{ error }}</p>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="{{ form.bio.id }}">
                                <i class="fas fa-edit"></i>
                                ä¸ªäººç®€ä»‹
                            </label>
                            {{ form.bio(class="form-textarea", placeholder="è¯´è¯´ä½ å–œæ¬¢ä»€ä¹ˆå§ï¼Œæ¯”å¦‚å–œæ¬¢ç”»ä»€ä¹ˆ...") }}
                            {% if form.bio.errors %}
                                <div class="error-messages">
                                    {% for error in form.bio.errors %}
                                        <p class="error-message">{{ error }}</p>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i>
                                ä¿å­˜ä¿®æ”¹
                            </button>
                        </div>
                    </form>
                </div>

                <!-- éšç§è®¾ç½® -->
                <div class="privacy-section">
                    <h2>ğŸ”’ éšç§è®¾ç½®</h2>
                    
                    <form method="POST" action="{{ url_for('auth.profile') }}" class="privacy-form">
                        {{ privacy_form.hidden_tag() }}
                        <input type="hidden" name="form_type" value="privacy">
                        
                        
                        <div class="privacy-settings">
                            <div class="privacy-item">
                                <div class="privacy-info">
                                    <h4>ä½œå“å±•ç¤º</h4>
                                    <p>å…è®¸å…¶ä»–äººåœ¨ä½œå“å±•ç¤ºé¡µé¢çœ‹åˆ°æˆ‘çš„ä½œå“</p>
                                </div>
                                <div class="privacy-toggle">
                                    {{ privacy_form.show_in_gallery(style="display: none;", id="show_in_gallery_checkbox") }}
                                    <label for="show_in_gallery_checkbox" class="toggle-switch">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="privacy-item">
                                <div class="privacy-info">
                                    <h4>æ˜¾ç¤ºå¹´é¾„</h4>
                                    <p>åœ¨ä½œå“ä¸Šæ˜¾ç¤ºæˆ‘çš„å¹´é¾„ä¿¡æ¯</p>
                                </div>
                                <div class="privacy-toggle">
                                    {{ privacy_form.show_age(style="display: none;", id="show_age_checkbox") }}
                                    <label for="show_age_checkbox" class="toggle-switch">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="privacy-item">
                                <div class="privacy-info">
                                    <h4>ä½¿ç”¨æŠ¥å‘Š</h4>
                                    <p>å‘å®¶é•¿å‘é€æˆ‘çš„ä½¿ç”¨æƒ…å†µæŠ¥å‘Š</p>
                                </div>
                                <div class="privacy-toggle">
                                    {{ privacy_form.allow_parent_reports(style="display: none;", id="allow_parent_reports_checkbox") }}
                                    <label for="allow_parent_reports_checkbox" class="toggle-switch">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-secondary">
                                <i class="fas fa-shield-check"></i>
                                æ›´æ–°éšç§è®¾ç½®
                            </button>
                        </div>
                    </form>
                </div>

                <!-- ä½¿ç”¨ç»Ÿè®¡ -->
                <div class="usage-stats-section">
                    <h2>ğŸ“Š ä½¿ç”¨ç»Ÿè®¡</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-content">
                                <h4>æ€»ä½¿ç”¨æ—¶é•¿</h4>
                                <p class="stat-value">{{ total_hours }}å°æ—¶</p>
                                <p class="stat-detail">ä»Šå¤©ä½¿ç”¨äº†{{ today_hours }}å°æ—¶</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-heart"></i>
                            </div>
                            <div class="stat-content">
                                <h4>æœ€å–œæ¬¢çš„åŠŸèƒ½</h4>
                                <p class="stat-value">AIä¸Šè‰²</p>
                                <p class="stat-detail">ä½¿ç”¨äº†{{ coloring_count }}æ¬¡</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-thumbs-up"></i>
                            </div>
                            <div class="stat-content">
                                <h4>è·å¾—ç‚¹èµ</h4>
                                <p class="stat-value">{{ total_likes }}</p>
                                <p class="stat-detail">æ¥è‡ªå…¶ä»–å°æœ‹å‹</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å®¶é•¿ä¿¡æ¯ -->
                <div class="parent-section">
                    <h2>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶é•¿ä¿¡æ¯</h2>
                    <div class="parent-info-card">
                        <div class="parent-contact">
                            <i class="fas fa-envelope"></i>
                            <span>å®¶é•¿é‚®ç®±ï¼š{{ current_user.parent_email }}</span>
                        </div>
                        <div class="parent-actions">
                            {% if current_user.verification_token %}
                            <a href="{{ url_for('auth.parent_dashboard', verification_token=current_user.verification_token) }}" 
                               class="btn btn-outline">
                                <i class="fas fa-tachometer-alt"></i>
                                å®¶é•¿æ§åˆ¶å°
                            </a>
                            {% else %}
                            <span class="btn btn-outline disabled">
                                <i class="fas fa-tachometer-alt"></i>
                                å®¶é•¿æ§åˆ¶å°ï¼ˆä¸å¯ç”¨ï¼‰
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 AIåˆ›æ„å·¥åŠ - è®©æ¯ä¸ªå­©å­éƒ½æˆä¸ºå°å°åˆ›ä½œå®¶</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // éšç§å¼€å…³åŠ¨ç”»
            const toggleSwitches = document.querySelectorAll('.toggle-switch');
            toggleSwitches.forEach(toggle => {
                const checkbox = toggle.previousElementSibling;
                if (checkbox && checkbox.checked) {
                    toggle.classList.add('active');
                }
                
                checkbox.addEventListener('change', function() {
                    toggle.classList.toggle('active', this.checked);
                });
            });

            // æˆå°±å¾½ç« åŠ¨ç”»
            const achievementBadges = document.querySelectorAll('.achievement-badge.earned');
            achievementBadges.forEach((badge, index) => {
                setTimeout(() => {
                    badge.style.animation = `badgeGlow 2s ease-in-out infinite ${index * 0.5}s`;
                }, 1000);
            });

            // è¡¨å•æäº¤æˆåŠŸæç¤º
            const forms = document.querySelectorAll('form');
            forms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    const submitBtn = form.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¿å­˜ä¸­...';
                        submitBtn.disabled = true;
                    }
                });
            });

            // ç»Ÿè®¡æ•°å­—æ»šåŠ¨åŠ¨ç”»
            const statNumbers = document.querySelectorAll('.stat-number');
            statNumbers.forEach(statNumber => {
                const targetValue = parseInt(statNumber.textContent);
                let currentValue = 0;
                const increment = targetValue / 20;
                
                const timer = setInterval(() => {
                    currentValue += increment;
                    if (currentValue >= targetValue) {
                        statNumber.textContent = targetValue;
                        clearInterval(timer);
                    } else {
                        statNumber.textContent = Math.floor(currentValue);
                    }
                }, 50);
            });
        });

        // æ·»åŠ CSSåŠ¨ç”»å’Œæ ·å¼
        const style = document.createElement('style');
        style.textContent = `
            @keyframes badgeGlow {
                0%, 100% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
                50% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); }
            }
            
            /* éšç§è®¾ç½®æ»‘åŠ¨å¼€å…³æ ·å¼ */
            .privacy-toggle {
                display: flex;
                align-items: center;
                position: relative;
            }
            
            .toggle-switch {
                position: relative;
                display: inline-block;
                width: 50px;
                height: 26px;
                background-color: #ddd;
                border-radius: 26px;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            }
            
            .toggle-switch:hover {
                background-color: #ccc;
            }
            
            .toggle-switch.active {
                background-color: #007bff;
                box-shadow: inset 0 2px 4px rgba(0,123,255,0.2);
            }
            
            .toggle-switch.active:hover {
                background-color: #0056b3;
            }
            
            .toggle-slider {
                position: absolute;
                top: 2px;
                left: 2px;
                width: 22px;
                height: 22px;
                background-color: white;
                border-radius: 50%;
                transition: all 0.3s ease;
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            }
            
            .toggle-switch.active .toggle-slider {
                transform: translateX(24px);
                box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            }
            
            /* éšç§è®¾ç½®é¡¹å¸ƒå±€ */
            .privacy-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px 0;
                border-bottom: 1px solid #f0f0f0;
            }
            
            .privacy-item:last-child {
                border-bottom: none;
            }
            
            .privacy-info h4 {
                margin: 0 0 5px 0;
                font-size: 16px;
                color: #333;
            }
            
            .privacy-info p {
                margin: 0;
                font-size: 14px;
                color: #666;
                line-height: 1.4;
            }
        `;
        document.head.appendChild(style);

        // è§’è‰²å’Œå‡ºç”Ÿæ—¥æœŸçš„åŠ¨æ€æç¤º
        const roleSelect = document.getElementById('role-select');
        const ageHint = document.getElementById('age-hint');
        const birthDateInput = document.getElementById('birth-date-input');
        
        function updateAgeHint() {
            const role = roleSelect.value;
            if (role === 'student') {
                ageHint.textContent = '(å­¦ç”Ÿï¼š5-24å²)';
                ageHint.style.color = '#28a745';
            } else if (role === 'teacher' || role === 'parent') {
                ageHint.textContent = '(è€å¸ˆ/å®¶é•¿ï¼š20-80å²)';
                ageHint.style.color = '#007bff';
            }
        }
        
        function calculateAge(birthDate) {
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            
            return age;
        }
        
        function updateAgeDisplay() {
            if (birthDateInput && birthDateInput.value) {
                const age = calculateAge(birthDateInput.value);
                const ageDisplay = document.createElement('span');
                ageDisplay.textContent = ` (å½“å‰å¹´é¾„: ${age}å²)`;
                ageDisplay.style.color = '#666';
                ageDisplay.style.fontSize = '0.9em';
                ageDisplay.id = 'age-display';
                
                // ç§»é™¤ä¹‹å‰çš„å¹´é¾„æ˜¾ç¤º
                const oldDisplay = document.getElementById('age-display');
                if (oldDisplay) {
                    oldDisplay.remove();
                }
                
                // æ·»åŠ åˆ°å‡ºç”Ÿæ—¥æœŸæ ‡ç­¾åé¢
                const label = document.querySelector('label[for="birth-date-input"]');
                if (label) {
                    label.appendChild(ageDisplay);
                }
            }
        }
        
        // åˆå§‹åŒ–éšç§è®¾ç½®åˆ‡æ¢å¼€å…³
        function initPrivacyToggles() {
            // ç›´æ¥æŸ¥æ‰¾æ‰€æœ‰éšç§è®¾ç½®é¡¹
            const privacyItems = document.querySelectorAll('.privacy-item');
            
            privacyItems.forEach((item, index) => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                const label = item.querySelector('label.toggle-switch');
                
                if (!checkbox || !label) {
                    return;
                }
                
                // åˆå§‹åŒ–å¼€å…³çŠ¶æ€
                updateToggleState(label, checkbox.checked);
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶åˆ°æ ‡ç­¾
                label.addEventListener('click', function(e) {
                    e.preventDefault();
                    checkbox.checked = !checkbox.checked;
                    updateToggleState(this, checkbox.checked);
                    
                    // è§¦å‘changeäº‹ä»¶ä»¥ä¾¿è¡¨å•éªŒè¯
                    checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                });
            });
        }
        
        // æ›´æ–°åˆ‡æ¢å¼€å…³çš„è§†è§‰çŠ¶æ€
        function updateToggleState(toggleElement, isActive) {
            if (isActive) {
                toggleElement.classList.add('active');
            } else {
                toggleElement.classList.remove('active');
            }
        }
        
        if (roleSelect && ageHint) {
            // åˆå§‹åŒ–æç¤º
            updateAgeHint();
            
            // è§’è‰²æ”¹å˜æ—¶æ›´æ–°æç¤º
            roleSelect.addEventListener('change', updateAgeHint);
        }
        
        if (birthDateInput) {
            // åˆå§‹åŒ–å¹´é¾„æ˜¾ç¤º
            updateAgeDisplay();
            
            // å‡ºç”Ÿæ—¥æœŸæ”¹å˜æ—¶æ›´æ–°å¹´é¾„æ˜¾ç¤º
            birthDateInput.addEventListener('change', updateAgeDisplay);
        }
        
        // åˆå§‹åŒ–éšç§è®¾ç½®åˆ‡æ¢å¼€å…³
        initPrivacyToggles();
    });
    </script>
</body>
</html>