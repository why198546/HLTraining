<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI创作工坊 - 开始创作</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <header class="header">
        <nav class="navbar">
            <div class="nav-brand">
                <i class="fas fa-magic"></i>
                <span>AI创意工坊</span>
            </div>
            <ul class="nav-menu">
                <li><a href="{{ url_for('index') }}" class="nav-link">首页</a></li>
                <li><a href="/create" class="nav-link active">开始创作</a></li>
                <li><a href="/gallery" class="nav-link">作品展示</a></li>
                <li><a href="/tutorial" class="nav-link">使用教程</a></li>
            </ul>
            <div class="nav-toggle">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </nav>
    </header>

    <main class="main-content create-page">
        <div class="container">
            <!-- 创作进度指示器 -->
            <div class="creation-progress">
                <div class="progress-step active" id="step-1">
                    <div class="step-number">1</div>
                    <span>创作输入</span>
                </div>
                <div class="progress-line"></div>
                <div class="progress-step" id="step-2">
                    <div class="step-number">2</div>
                    <span>图片生成</span>
                </div>
                <div class="progress-line"></div>
                <div class="progress-step" id="step-3">
                    <div class="step-number">3</div>
                    <span>调整优化</span>
                </div>
                <div class="progress-line"></div>
                <div class="progress-step" id="step-4">
                    <div class="step-number">4</div>
                    <span>3D模型</span>
                </div>
            </div>

            <!-- 创作工作区 -->
            <div class="creation-workspace">
                <!-- 第一步：创作输入 -->
                <div id="input-stage" class="creation-stage active">
                    <div class="stage-header">
                        <h2><i class="fas fa-lightbulb"></i> 描述你的创意</h2>
                        <p>用文字描述你的想法，或上传线稿图片作为参考</p>
                    </div>

                    <div class="creation-input-area">
                        <div class="prompt-input-container">
                            <div class="input-wrapper">
                                <textarea 
                                    id="creation-prompt" 
                                    class="creation-input" 
                                    placeholder="例如：一只可爱的小猫咪，戴着红色的帽子，坐在彩虹上...&#10;&#10;你可以只用文字描述，也可以上传图片作为参考！"
                                    rows="4"
                                ></textarea>
                                <button class="add-image-btn" onclick="triggerImageUpload()" title="上传参考图片">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <input type="file" id="reference-image" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                            </div>
                            <div class="input-hint">
                                💡 <strong>创作小贴士：</strong>可以描述颜色、形状、表情、背景等细节，或上传线稿图片
                            </div>
                        </div>

                        <!-- 上传的图片预览 -->
                        <div id="uploaded-image-preview" class="image-preview" style="display: none;">
                            <div class="preview-header">
                                <span><i class="fas fa-image"></i> 参考图片</span>
                                <button class="remove-image-btn" onclick="removeUploadedImage()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <img id="uploaded-image" src="" alt="上传的参考图片">
                        </div>
                        
                        <div class="generation-options">
                            <div class="option-group">
                                <label>图片风格：</label>
                                <select id="image-style" class="style-select">
                                    <option value="cute">可爱卡通</option>
                                    <option value="realistic">写实风格</option>
                                    <option value="anime">动漫风格</option>
                                    <option value="fantasy">奇幻风格</option>
                                </select>
                            </div>
                            <div class="option-group">
                                <label>色彩偏好：</label>
                                <select id="color-preference" class="style-select">
                                    <option value="colorful">色彩丰富</option>
                                    <option value="pastel">柔和色调</option>
                                    <option value="bright">明亮鲜艳</option>
                                    <option value="natural">自然色彩</option>
                                </select>
                            </div>
                        </div>
                        
                        <button id="generate-image" class="generate-btn">
                            <i class="fas fa-wand-magic-sparkles"></i>
                            生成图片
                        </button>
                    </div>
                </div>

                <!-- 第二步：生成结果 -->
                <div id="generation-stage" class="creation-stage">
                    <div class="stage-header">
                        <h2><i class="fas fa-image"></i> AI生成结果</h2>
                        <p>查看AI为你生成的图片，你可以重新生成或进行调整</p>
                    </div>

                    <div class="generated-image-container">
                        <img id="generated-image" src="" alt="AI生成的图片">
                        <div class="image-actions">
                            <button class="action-btn regenerate-btn" onclick="regenerateImage()">
                                <i class="fas fa-redo"></i>
                                重新生成
                            </button>
                            <button class="action-btn adjust-btn" onclick="showAdjustPanel()">
                                <i class="fas fa-sliders-h"></i>
                                调整图片
                            </button>
                            <button class="action-btn confirm-btn" onclick="confirmImage()">
                                <i class="fas fa-check"></i>
                                确认图片
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 第三步：调整阶段 -->
                <div id="adjustment-stage" class="creation-stage">
                    <div class="stage-header">
                        <h2><i class="fas fa-edit"></i> 图片调整</h2>
                        <p>告诉AI你希望如何调整图片</p>
                    </div>

                    <div class="adjustment-workspace">
                        <div class="current-image">
                            <h4>当前图片</h4>
                            <img id="current-image" src="" alt="当前图片">
                        </div>

                        <div class="adjust-panel">
                            <h4><i class="fas fa-edit"></i> 调整提示</h4>
                            <textarea 
                                id="adjustment-prompt" 
                                class="adjustment-input" 
                                placeholder="例如：让颜色更鲜艳一些，改变背景为森林..."
                                rows="3"
                            ></textarea>
                            <div class="adjust-actions">
                                <button class="apply-adjust-btn" onclick="applyAdjustment()">
                                    <i class="fas fa-check"></i>
                                    应用调整
                                </button>
                                <button class="cancel-adjust-btn" onclick="skipAdjustment()">
                                    <i class="fas fa-arrow-right"></i>
                                    跳过调整
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 第四步：3D模型生成 -->
                <div id="model-stage" class="creation-stage">
                    <div class="stage-header">
                        <h2><i class="fas fa-cube"></i> 3D模型生成</h2>
                        <p>基于你的图片生成3D模型</p>
                    </div>

                    <!-- 3D模型提示词输入 -->
                    <div class="model-prompt-section">
                        <h4><i class="fas fa-magic"></i> 3D模型生成提示词（可选）</h4>
                        <textarea 
                            id="model-prompt" 
                            class="model-prompt-input" 
                            placeholder="例如：制作成Q版风格，增加金属质感，让姿态更加动感..."
                            rows="2"
                        ></textarea>
                        <div class="prompt-tips">
                            <i class="fas fa-lightbulb"></i>
                            <span>提示：可以描述希望的风格、材质、姿态等特征来优化3D模型效果</span>
                        </div>
                    </div>

                    <!-- 图片和3D模型并排显示区域 -->
                    <div class="image-model-comparison">
                        <div class="final-image-section">
                            <h4><i class="fas fa-image"></i> 原始图片</h4>
                            <div class="image-preview-container">
                                <img id="final-image" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='200'%3E%3Crect width='100%25' height='100%25' fill='%23f0f0f0'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' fill='%23999'%3E正在加载图片...%3C/text%3E%3C/svg%3E" alt="最终确认的图片" style="display: block;">
                            </div>
                        </div>

                        <div class="model-preview-section">
                            <h4><i class="fas fa-cube"></i> 3D模型预览</h4>
                            <div class="model-preview-wrapper">
                                <!-- 左侧控制面板 -->
                                <div class="left-controls-panel" id="leftControlsPanel" style="display: none;">
                                    <!-- 显示控制 -->
                                    <div class="control-group-vertical">
                                        <div class="control-title">
                                            <i class="fas fa-eye"></i>
                                            <span>显示</span>
                                        </div>
                                        <button class="side-control-btn" id="renderSolid" title="实体模式">
                                            <i class="fas fa-cube"></i>
                                        </button>
                                        <button class="side-control-btn" id="renderWireframe" title="线框模式">
                                            <i class="fas fa-project-diagram"></i>
                                        </button>
                                        <button class="side-control-btn" id="renderPoints" title="点云模式">
                                            <i class="fas fa-braille"></i>
                                        </button>
                                    </div>
                                    
                                    <!-- 材质设置 -->
                                    <div class="control-group-vertical">
                                        <div class="control-title">
                                            <i class="fas fa-palette"></i>
                                            <span>材质</span>
                                        </div>
                                        <button class="side-control-btn" id="materialOriginal" title="原始材质">
                                            <i class="fas fa-palette"></i>
                                        </button>
                                        <button class="side-control-btn" id="materialLambert" title="朗伯材质">
                                            <i class="fas fa-sun"></i>
                                        </button>
                                        <button class="side-control-btn" id="materialPhong" title="光泽材质">
                                            <i class="fas fa-gem"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- 3D模型容器 -->
                                <div class="model-container" id="modelContainer">
                                    <div class="model-placeholder">
                                        <i class="fas fa-cube"></i>
                                        <p>点击下方按钮生成3D模型</p>
                                    </div>
                                </div>
                                
                                <!-- 右侧控制面板 -->
                                <div class="right-controls-panel" id="rightControlsPanel" style="display: none;">
                                    <!-- 环境设置 -->
                                    <div class="control-group-vertical">
                                        <div class="control-title">
                                            <i class="fas fa-globe"></i>
                                            <span>环境</span>
                                        </div>
                                        <button class="side-control-btn" id="toggleBackground" title="切换背景">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <div class="light-control">
                                            <i class="fas fa-lightbulb"></i>
                                            <input type="range" id="lightIntensity" min="0" max="2" step="0.1" value="0.8" 
                                                   class="vertical-slider" title="光照强度">
                                        </div>
                                    </div>
                                    
                                    <!-- 模型操作 -->
                                    <div class="control-group-vertical">
                                        <div class="control-title">
                                            <i class="fas fa-tools"></i>
                                            <span>操作</span>
                                        </div>
                                        <button class="side-control-btn" id="resetModel" title="重置模型">
                                            <i class="fas fa-undo"></i>
                                        </button>
                                        <button class="side-control-btn" id="centerModel" title="居中显示">
                                            <i class="fas fa-crosshairs"></i>
                                        </button>
                                        <button class="side-control-btn close-btn" onclick="hideModelControls()" title="关闭控制面板">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 生成控制按钮区域 -->
                    <div class="model-controls-section">
                        <button id="generate-3d" class="generate-btn">
                            <i class="fas fa-cube"></i>
                            生成3D模型
                        </button>
                        
                        <div class="model-actions" id="model-actions" style="display: none;">
                            <button class="control-btn" id="rotateModel">
                                <i class="fas fa-sync-alt"></i>
                                自动旋转
                            </button>
                            <button class="control-btn" id="resetView">
                                <i class="fas fa-eye"></i>
                                重置视角
                            </button>
                            <button class="download-btn" id="download3D">
                                <i class="fas fa-download"></i>
                                下载模型
                            </button>
                        </div>
                    </div>

                    <!-- 生成信息提示 -->
                    <div class="generation-info" id="generation-info" style="display: none;">
                        <i class="fas fa-info-circle"></i>
                        <p>3D模型生成需要一些时间，请耐心等待...</p>
                    </div>
                </div>

                    <!-- 完成操作 -->
                    <div class="final-actions" style="display: none;" id="final-actions">
                        <button class="save-artwork-btn" onclick="showSaveArtworkDialog()">
                            <i class="fas fa-heart"></i>
                            保存到作品集
                        </button>
                        <button class="download-btn" onclick="downloadImage()">
                            <i class="fas fa-download"></i>
                            下载图片
                        </button>
                        <button class="secondary-btn" onclick="startNewCreation()">
                            <i class="fas fa-plus"></i>
                            创建新作品
                        </button>
                        <button class="primary-btn" onclick="shareCreation()">
                            <i class="fas fa-share"></i>
                            分享我的创作
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 加载覆盖层 -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">AI正在创作中...</div>
            <div class="loading-subtitle">请稍等片刻，好作品值得等待 ✨</div>
            
            <!-- 3D模型生成进度条 -->
            <div id="progress-container" style="display: none;">
                <div class="progress-bar-container">
                    <div class="progress-bar">
                        <div id="progress-fill" class="progress-fill"></div>
                    </div>
                    <div class="progress-info">
                        <span id="progress-text">0%</span>
                        <span id="progress-time">预估剩余: 计算中...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 消息提示 -->
    <div id="message-toast" class="message-toast"></div>

    <!-- 保存作品对话框 -->
    <div id="save-artwork-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content save-artwork-modal">
            <div class="modal-header">
                <h3><i class="fas fa-heart"></i> 保存作品到作品集</h3>
                <button class="modal-close" onclick="closeSaveArtworkDialog()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="artwork-preview">
                    <div class="preview-item">
                        <h4>原始简笔画</h4>
                        <img id="preview-original" src="" alt="原始图片">
                    </div>
                    <div class="preview-item">
                        <h4>AI生成效果</h4>
                        <img id="preview-generated" src="" alt="生成图片">
                    </div>
                </div>
                
                <div class="artwork-form">
                    <div class="form-group">
                        <label for="artwork-title">作品标题 *</label>
                        <input type="text" id="artwork-title" placeholder="给你的作品起个好听的名字" maxlength="50" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="artist-name">创作者姓名 *</label>
                            <input type="text" id="artist-name" placeholder="你的名字" maxlength="20" required>
                        </div>
                        <div class="form-group">
                            <label for="artist-age">年龄</label>
                            <select id="artist-age">
                                <option value="8">8岁</option>
                                <option value="9">9岁</option>
                                <option value="10" selected>10岁</option>
                                <option value="11">11岁</option>
                                <option value="12">12岁</option>
                                <option value="13">13岁</option>
                                <option value="14">14岁</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="artwork-category">作品分类</label>
                        <select id="artwork-category">
                            <option value="animals">动物</option>
                            <option value="characters">人物</option>
                            <option value="objects">物品</option>
                            <option value="nature">自然</option>
                            <option value="other">其他</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="artwork-description">作品介绍</label>
                        <textarea id="artwork-description" placeholder="介绍一下你的创作想法和故事..." maxlength="200"></textarea>
                        <small>可选，最多200字</small>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="secondary-btn" onclick="closeSaveArtworkDialog()">取消</button>
                <button class="primary-btn" onclick="saveArtworkToGallery()">
                    <i class="fas fa-heart"></i>
                    保存到作品集
                </button>
            </div>
        </div>
    </div>

    <!-- Three.js库用于3D模型展示 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/MTLLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    
    <!-- 3D模型查看器模块 -->
    <script src="{{ url_for('static', filename='js/model-viewer-3d.js') }}"></script>
    <!-- 创作页面JavaScript -->
    <script src="{{ url_for('static', filename='js/create.js') }}"></script>
</body>
</html>